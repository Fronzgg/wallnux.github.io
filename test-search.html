<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #36393f;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
        }
        .result {
            background: #2f3136;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            background: #5865f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .info {
            flex: 1;
        }
        button.add {
            background: #3ba55d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
        }
        button.add:hover {
            background: #2d7d46;
        }
        button.add:disabled {
            background: #747f8d;
            cursor: not-allowed;
        }
        #log {
            background: #1e2124;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π</h1>
        
        <div>
            <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <button onclick="searchUsers()">–ù–∞–π—Ç–∏</button>
        </div>
        
        <div id="results"></div>
        
        <div id="log"></div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            log('üîç –ü–æ–∏—Å–∫: ' + query);
            
            if (!query) {
                log('‚ùå –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å');
                return;
            }
            
            if (!token) {
                log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                return;
            }
            
            try {
                log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/users/search...');
                
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å: ' + response.status);
                
                if (!response.ok) {
                    log('‚ùå –û—à–∏–±–∫–∞: ' + response.status);
                    return;
                }
                
                const results = await response.json();
                log('‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + results.length);
                log('üìã –î–∞–Ω–Ω—ã–µ: ' + JSON.stringify(results, null, 2));
                
                displayResults(results);
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                console.error(error);
            }
        }
        
        function displayResults(users) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (users.length === 0) {
                resultsDiv.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            users.forEach(user => {
                log('üë§ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º: ' + user.username + ' (—Å—Ç–∞—Ç—É—Å: ' + user.friendshipStatus + ')');
                
                const div = document.createElement('div');
                div.className = 'result';
                
                let buttonHTML = '';
                if (user.friendshipStatus === 'friends') {
                    buttonHTML = '<button class="add" disabled>‚úì –£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö</button>';
                } else if (user.friendshipStatus === 'pending_sent') {
                    buttonHTML = '<button class="add" disabled>–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</button>';
                } else if (user.friendshipStatus === 'pending_received') {
                    buttonHTML = '<button class="add" disabled>–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞</button>';
                } else {
                    buttonHTML = `<button class="add" onclick="addFriend(${user.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>`;
                }
                
                div.innerHTML = `
                    <div class="avatar">${user.username.charAt(0).toUpperCase()}</div>
                    <div class="info">
                        <div><strong>${user.username}</strong></div>
                        <div style="font-size: 12px; color: #b9bbbe;">${user.email}</div>
                    </div>
                    ${buttonHTML}
                `;
                
                resultsDiv.appendChild(div);
            });
            
            log('‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
        }
        
        async function addFriend(userId) {
            log('üì® –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ' + userId);
            
            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ friendId: userId })
                });
                
                if (response.ok) {
                    log('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    alert('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    // –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    searchUsers();
                } else {
                    log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Enter
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });
        
        log('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        log('Token: ' + (token ? '–Ω–∞–π–¥–µ–Ω' : '–ù–ï –ù–ê–ô–î–ï–ù'));
    </script>
</body>
</html>
